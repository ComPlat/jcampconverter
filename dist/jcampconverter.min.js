!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.JcampConverter=t():e.JcampConverter=t()}("undefined"!=typeof self?self:this,function(){return function(e){var t={};function r(a){if(t[a])return t[a].exports;var n=t[a]={i:a,l:!1,exports:{}};return e[a].call(n.exports,n,n.exports,r),n.l=!0,n.exports}return r.m=e,r.c=t,r.d=function(e,t,a){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:a})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(r.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var n in e)r.d(a,n,function(t){return e[t]}.bind(null,n));return a},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=0)}([function(e,t,r){"use strict";function a(){const e=/[, \t]+/,t=["TIC",".RIC","SCANNUMBER"];function r(e){for(var t=e.length,r=new Array(t),a=0;a<t;a++)r[a]=parseFloat(e[a]);return r}class a{}const n={keepRecordsRegExp:/^$/,xy:!1,withoutXY:!1,chromatogram:!1,keepSpectra:!1,noContour:!1,nbContourLevels:7,noiseMultiplier:5};function i(e){return e.toLowerCase().replace(/[^a-z0-9]/g,"")}function s(e){return-1!==t.indexOf(e)}function o(e,t){if(t.xFactor||(t.xFactor=1),t.yFactor||(t.yFactor=1),t.observeFrequency&&t.xUnit&&"HZ"===t.xUnit.toUpperCase()&&(t.xUnit="PPM",t.xFactor=t.xFactor/t.observeFrequency,t.firstX=t.firstX/t.observeFrequency,t.lastX=t.lastX/t.observeFrequency,t.deltaX=t.deltaX/t.observeFrequency),e.shiftOffsetVal){var r=t.firstX-e.shiftOffsetVal;t.firstX=t.firstX-r,t.lastX=t.lastX-r}}function l(e,t){return e-t}function f(e,t){var r=e.yFactor,a=e.deltaX;e.isXYdata=!0;var n=[];e.data=[n];for(var i,s=e.firstX,o=e.firstY,l=!1,f=0;f<t.length;f++)if(13===(i=t.charCodeAt(f))||10===i)l=!0;else if(l)break;for(var p=!0,u=!1,c=!1,h=0,g=!1,d=!1,m=0,v=!1,y=!1,x=!1,F=0;f<=t.length;f++)if(i=f===t.length?13:t.charCodeAt(f),d)13!==i&&10!==i||(p=!0,d=!1);else if(i<=57&&i>=48)y=!0,F>0?m+=(i-48)/Math.pow(10,F++):(m*=10,m+=i-48);else if(44===i||46===i)y=!0,F++;else{if(y){if(p)p=!1,c&&(x=!0);else if(x)x=!1;else{u&&(h=v?0-m:m,c=!0,u=!1);for(var b=g?m-1:1,A=0;A<b;A++)c?o+=h:o=v?0-m:m,n.push(s),n.push(o*r),s+=a}v=!1,m=0,F=0,y=!1,g=!1}if(i<74&&i>63)y=!0,c=!1,m=i-64;else if(i>96&&i<106)y=!0,c=!1,m=i-96,v=!0;else if(115===i)y=!0,g=!0,m=9;else if(i>82&&i<91)y=!0,g=!0,m=i-82;else if(i>73&&i<83)y=!0,u=!0,m=i-73;else if(i>105&&i<115)y=!0,u=!0,m=i-105,v=!0;else if(36===i&&36===t.charCodeAt(f+1))y=!0,d=!0;else if(37===i)y=!0,u=!0,m=0,v=!1;else if(45===i){var T=t.charCodeAt(f+1);(T>=48&&T<=57||44===T||46===T)&&(y=!0,p||(c=!1),v=!0)}else 13!==i&&10!==i||(p=!0,d=!1)}}function p(e,t,r){var a,n,i,s,o,l=/\$\$.*/,f=/[,\t ]+/;e.isPeaktable=!0;var p=[];e.data=[p];var u=t.split(/,? *,?[;\r\n]+ */);for(a=1,n=u.length;a<n;a++)if((o=u[a].trim().replace(l,"").split(f)).length%2==0)for(i=0,s=o.length;i<s;i+=2)p.push(parseFloat(o[i])*e.xFactor),p.push(parseFloat(o[i+1])*e.yFactor);else r.logs.push(`Format error: ${o}`)}return function(u,c){var h,g,d,m,v,y,x,F,b,A,T=!(c=Object.assign({},n,c)).withoutXY,O=Date.now(),X={},E={profiling:[],logs:[]},S=[];E.spectra=S,E.info={};var w=new a;if("string"!=typeof u)throw new TypeError("the JCAMP should be a string");for(E.profiling&&E.profiling.push({action:"Before split to LDRS",time:Date.now()-O}),m=u.split(/[\r\n]+##/),E.profiling&&E.profiling.push({action:"Split to LDRS",time:Date.now()-O}),m[0]&&(m[0]=m[0].replace(/^[\r\n ]*##/,"")),v=0,y=m.length;v<y;v++){if((F=(h=m[v]).indexOf("="))>0?(g=h.substring(0,F),d=h.substring(F+1).trim()):(g=h,d=""),"DATATABLE"===(g=g.replace(/[_ -]/g,"").toUpperCase())&&(-1===(b=d.indexOf("\n"))&&(b=d.indexOf("\r")),b>0)){var C=-1,R=-1;if((A=d.substring(0,b).split(/[ ,;\t]+/))[0].indexOf("++")>0){var M=A[0].replace(/.*\(([a-zA-Z0-9]+)\+\+.*/,"$1"),P=A[0].replace(/.*\.\.([a-zA-Z0-9]+).*/,"$1");C=X.symbol.indexOf(M),R=X.symbol.indexOf(P)}-1===C&&(C=0),-1===R&&(R=0),X.first&&(X.first.length>C&&(w.firstX=X.first[C]),X.first.length>R&&(w.firstY=X.first[R])),X.last&&(X.last.length>C&&(w.lastX=X.last[C]),X.last.length>R&&(w.lastY=X.last[R])),X.vardim&&X.vardim.length>C&&(w.nbPoints=X.vardim[C]),X.factor&&(X.factor.length>C&&(w.xFactor=X.factor[C]),X.factor.length>R&&(w.yFactor=X.factor[R])),X.units&&(X.units.length>C&&(w.xUnit=X.units[C]),X.units.length>R&&(w.yUnit=X.units[R])),w.datatable=A[0],A[1]&&A[1].indexOf("PEAKS")>-1?g="PEAKTABLE":A[1]&&(A[1].indexOf("XYDATA")||A[0].indexOf("++")>0)&&(g="XYDATA",w.deltaX=(w.lastX-w.firstX)/(w.nbPoints-1))}if("XYDATA"!==g)if("PEAKTABLE"!==g){if("TITLE"===g)w.title=d;else if("DATATYPE"===g)w.dataType=d,d.indexOf("nD")>-1&&(E.twoD=!0);else if("NTUPLES"===g)d.indexOf("nD")>-1&&(E.twoD=!0);else if("XUNITS"===g)w.xUnit=d;else if("YUNITS"===g)w.yUnit=d;else if("FIRSTX"===g)w.firstX=parseFloat(d);else if("LASTX"===g)w.lastX=parseFloat(d);else if("FIRSTY"===g)w.firstY=parseFloat(d);else if("LASTY"===g)w.lastY=parseFloat(d);else if("NPOINTS"===g)w.nbPoints=parseFloat(d);else if("XFACTOR"===g)w.xFactor=parseFloat(d);else if("YFACTOR"===g)w.yFactor=parseFloat(d);else if("DELTAX"===g)w.deltaX=parseFloat(d);else if(".OBSERVEFREQUENCY"===g||"$SFO1"===g)w.observeFrequency||(w.observeFrequency=parseFloat(d));else if(".OBSERVENUCLEUS"===g)w.xType||(E.xType=d.replace(/[^a-zA-Z0-9]/g,""));else if("$SFO2"===g)E.indirectFrequency||(E.indirectFrequency=parseFloat(d));else if("$OFFSET"===g)E.shiftOffsetNum=0,E.shiftOffsetVal||(E.shiftOffsetVal=parseFloat(d));else if("$REFERENCEPOINT"===g);else if("VARNAME"===g)X.varname=d.split(e);else if("SYMBOL"===g)X.symbol=d.split(e);else if("VARTYPE"===g)X.vartype=d.split(e);else if("VARFORM"===g)X.varform=d.split(e);else if("VARDIM"===g)X.vardim=r(d.split(e));else if("UNITS"===g)X.units=d.split(e);else if("FACTOR"===g)X.factor=r(d.split(e));else if("FIRST"===g)X.first=r(d.split(e));else if("LAST"===g)X.last=r(d.split(e));else if("MIN"===g)X.min=r(d.split(e));else if("MAX"===g)X.max=r(d.split(e));else if(".NUCLEUS"===g)E.twoD&&(E.yType=d.split(e)[0]);else if("PAGE"===g){w.page=d.trim(),w.pageValue=parseFloat(d.replace(/^.*=/,"")),w.pageSymbol=w.page.replace(/[=].*/,"");var Y=X.symbol.indexOf(w.pageSymbol),D="";X.units&&X.units[Y]&&(D=X.units[Y]),E.indirectFrequency&&"PPM"!==D&&(w.pageValue/=E.indirectFrequency)}else"RETENTIONTIME"===g?w.pageValue=parseFloat(d):s(g)&&(w[i(g)]=d);g.match(c.keepRecordsRegExp)&&(E.info[g]=d.trim())}else T&&(o(E,w),p(w,d,E),S.push(w),w=new a);else T&&(o(E,w),d.match(/.*\+\+.*/)?(w.deltaX||(w.deltaX=(w.lastX-w.firstX)/(w.nbPoints-1)),f(w,d)):p(w,d,E),S.push(w),w=new a)}if(E.profiling&&E.profiling.push({action:"Finished parsing",time:Date.now()-O}),Object.keys(X).length>0){var L=[],N=Object.keys(X);for(v=0;v<N.length;v++){var U=N[v],j=X[U];for(x=0;x<j.length;x++)L[x]||(L[x]={}),L[x][U]=j[x]}E.ntuples=L}if(E.twoD&&T&&(function(e,t){var r=function(e){for(var t=e[0].data[0][0],r=t,a=e.length,n=e[0].data[0].length/2,i=new Array(a),s=0;s<a;s++){i[s]=new Array(n);for(var o=e[s].data[0],f=0;f<n;f++){var p=o[2*f+1];i[s][f]=p,p<t&&(t=p),p>r&&(r=p)}}return{z:i,minX:e[0].data[0][0],maxX:e[0].data[0][e[0].data[0].length-2],minY:e[0].pageValue,maxY:e[a-1].pageValue,minZ:t,maxZ:r,noise:(u=i[0].map(Math.abs),c=(u=u.sort(l)).length,u[Math.floor(c/2)])};var u,c}(e.spectra);t.noContour||(e.contourLines=function(e,t){for(var r,a,n,i,s,o,l,f,p,u,c,h,g,d=e.noise,m=e.z,v=m.length,y=m[0].length,x=e.minX,F=(e.maxX-x)/(y-1),b=e.minY,A=(e.maxY-b)/(v-1),T=e.minZ,O=e.maxZ,X=2*t.nbContourLevels,E=new Array(X),S=0;S<X;S++){var w={};E[S]=w;var C=S%2,R=(O-t.noiseMultiplier*d)*Math.exp((S>>1)-t.nbContourLevels);g=0===C?R+t.noiseMultiplier*d:0-R-t.noiseMultiplier*d;var M=[];if(w.zValue=g,w.lines=M,!(g<=T||g>=O))for(var P=0;P<v-1;P++)for(var Y=m[P],D=m[P+1],L=0;L<y-1;L++)r=Y[L],a=Y[L+1],n=D[L],i=D[L+1],l=n>g,f=i>g,(s=r>g)!=(o=a>g)&&s!==l&&(p=L+(g-r)/(a-r),u=P,c=L,h=P+(g-r)/(n-r),M.push(p*F+x),M.push(u*A+b),M.push(c*F+x),M.push(h*A+b)),f!==o&&f!==l&&(p=L+1,u=P+1-(g-i)/(a-i),c=L+1-(g-i)/(n-i),h=P+1,M.push(p*F+x),M.push(u*A+b),M.push(c*F+x),M.push(h*A+b)),o!==l&&(p=(L+1-(g-a)/(n-a))*F+x,u=(P+(g-a)/(n-a))*A+b,o!==s&&(c=L+1-(g-a)/(r-a),h=P,M.push(p),M.push(u),M.push(c*F+x),M.push(h*A+b)),l!==s&&(c=L,h=P+1-(g-n)/(r-n),M.push(p),M.push(u),M.push(c*F+x),M.push(h*A+b)),o!==f&&(c=L+1,h=P+(g-a)/(i-a),M.push(p),M.push(u),M.push(c*F+x),M.push(h*A+b)),l!==f&&(c=L+(g-n)/(i-n),h=P+1,M.push(p),M.push(u),M.push(c*F+x),M.push(h*A+b)))}return{minX:e.minX,maxX:e.maxX,minY:e.minY,maxY:e.maxY,segments:E}}(r,t),delete r.z),e.minMax=r}(E,c),E.profiling&&E.profiling.push({action:"Finished countour plot calculation",time:Date.now()-O}),c.keepSpectra||delete E.spectra),c.chromatogram&&(c.xy=!0),c.xy&&T&&S.length>0)for(v=0;v<S.length;v++)if((w=S[v]).data.length>0)for(x=0;x<w.data.length;x++){for(var V=w.data[x],I={x:new Array(V.length/2),y:new Array(V.length/2)},$=0;$<V.length;$+=2)I.x[$/2]=V[$],I.y[$/2]=V[$+1];w.data[x]=I}return c.chromatogram&&(E.spectra.length>1?function(e){var r,a=e.spectra,n=a.length,s={times:new Array(n),series:{ms:{dimension:2,data:new Array(n)}}},o=[];for(r=0;r<t.length;r++){var l=i(t[r]);a[0][l]&&(o.push(l),s.series[l]={dimension:1,data:new Array(n)})}for(r=0;r<n;r++){var f=a[r];s.times[r]=f.pageValue;for(var p=0;p<o.length;p++)s.series[o[p]].data[r]=parseFloat(f[o[p]]);f.data&&(s.series.ms.data[r]=[f.data[0].x,f.data[0].y])}e.chromatogram=s}(E):function(e){var t=e.spectra[0].data[0];e.chromatogram={times:t.x.slice(),series:{intensity:{dimension:1,data:t.y.slice()}}}}(E),E.profiling&&E.profiling.push({action:"Finished chromatogram calculation",time:Date.now()-O})),E.profiling&&E.profiling.push({action:"Total time",time:Date.now()-O}),E}}var n=a();var i,s={};e.exports={convert:function(e,t,r){return"boolean"==typeof t&&(r=t,t={}),r?function(e,t){var r;return i||(r=URL.createObjectURL(new Blob([`var getConverter =${a.toString()};var convert = getConverter(); onmessage = function (event) { var data = JSON.parse(event.data); postMessage(JSON.stringify({stamp: data.stamp, output: convert(data.input, data.options)})); };`],{type:"application/javascript"})),i=new Worker(r),URL.revokeObjectURL(r),i.addEventListener("message",function(e){var t=JSON.parse(e.data),r=t.stamp;s[r]&&s[r](t.output)})),new Promise(function(r){var a=`${Date.now()}${Math.random()}`;s[a]=r,i.postMessage(JSON.stringify({stamp:a,input:e,options:t}))})}(e,t):n(e,t)},createTree:function(e){const t=(arguments.length>1&&void 0!==arguments[1]?arguments[1]:{}).flatten,r=void 0!==t&&t;if("string"!=typeof e)throw new TypeError("the JCAMP should be a string");let a,n=e.split(/[\r\n]+/),i=[],s=[],o=[],l=0;for(var f=0;f<n.length;f++){var p=n[f];if("##NTUPLES"===p.substring(0,9)&&l++,"##TITLE"===p.substring(0,7)){let e=[p.substring(8).trim()];for(let t=f+1;t<n.length&&!n[t].startsWith("##");t++)e.push(n[t].trim());s.push({title:e.join("\n"),jcamp:`${p}\n`,children:[]}),a=s[s.length-1],i.push(a)}else if("##END"===p.substring(0,5)&&0===l){a.jcamp+=`${p}\n`;var u=s.pop();0!==s.length?(a=s[s.length-1]).children.push(u):(a=void 0,o.push(u))}else if(a&&a.jcamp){a.jcamp+=`${p}\n`;var c=p.match(/^##(.*?)=(.+)/);c&&"DATATYPE"===c[1].replace(/[ _-]/g,"").toUpperCase()&&(a.dataType=c[2].trim())}"##END"===p.substring(0,5)&&l>0&&l--}return r?(i.forEach(e=>{e.children=void 0}),i):o}}}])});